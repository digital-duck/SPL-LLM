# SPL VS Code extension

```bash
# original prompt
gemini "Based on the EBNF grammar in @spl-paper-v2.2.pdf, generate a TextMate JSON grammar for VS Code. Include keywords like PROMPT, SELECT, GENERATE, WITH BUDGET, and LIMIT. Map them to standard scopes like 'keyword.control' and 'storage.type'."

# my enhanced prompt
gemini "I have developed SPL - Structured Prompt Language, very similar to SQL - Structured Query Language (in syntax), Based on SPL EBNF grammar in @/home/wengong/projects/digital-duck/SPL/docs/grammar.ebnf, generate a TextMate JSON grammar for VS Code. Include keywords like PROMPT, SELECT, GENERATE, WITH BUDGET, and LIMIT, etc. Map them to standard scopes like 'keyword.control' and 'storage.type'."

gemini "Draft a professional 1-paragraph summary for my coworkers explaining why we chose a Declarative VS Code extension (SPL-LLM) instead of just using Python scripts. Focus on 'developer experience' and 'token observability'."

gemini "How can I add a validation rule to this VS Code extension that warns the user if a 'WITH BUDGET' clause exceeds 128,000 tokens (our company's current limit)?"

# Gemini enhanced prompt

"I have developed SPL (Structured Prompt Language), which is syntactically modeled after SQL. Using the EBNF grammar in @/home/wengong/projects/digital-duck/SPL/docs/grammar.ebnf as the source of truth, generate a tmLanguage.json file for a VS Code extension.

Requirements:

SQL-Parallel Highlighting: Map keywords to their closest SQL equivalents.

SELECT, FROM, WITH, AS, LIMIT: use keyword.control.sql.

PROMPT, GENERATE: use keyword.other.DML.sql (to treat them as primary actions).

WITH BUDGET: treat this as a single logical keyword (handle the space).

Scope Mapping:

Built-in Functions: rag(), memory(), context() should use support.function.builtin.

Numbers/Tokens: Numbers following LIMIT or BUDGET should use constant.numeric.

Model Names: Strings following USING MODEL should use entity.name.type or variable.other.

Comments: Include support for SQL-style comments (-- comment and /* block */).

Strings: Handle double-quoted strings with escape characters.

Output Format: Provide the full JSON structure with scopeName: source.spl."
```

## Steps to Build SPL-LLM VS Code Extension (Syntax Highlighting)

Now that you have created the `tmLanguage.json` file for SPL syntax highlighting, here are the next steps to build and run your VS Code extension:

1.  **Generate the Extension Project:**
    *   Install Yeoman and the VS Code Extension Generator (if you haven't already):
        ```bash
        npm install -g yo generator-code
        ```
    *   Run the Yeoman generator:
        ```bash
        yo code
        ```
    *   When prompted, select "New Language Support".
    *   Follow the prompts to enter details like the language name (e.g., "SPL"), language ID ("spl"), file extension (e.g., ".spl"), etc. This will scaffold a complete VS Code extension project.

2.  **Integrate Your `tmLanguage.json` File:**
    *   Navigate into the newly created extension project directory.
    *   Copy your `tmLanguage.json` file (which you previously generated) into the `syntaxes` directory of your new project. You will likely be overwriting a placeholder grammar file generated by `yo code`.

3.  **Configure `package.json`:**
    *   Open the `package.json` file at the root of your new extension project.
    *   Review the `contributes.languages` and `contributes.grammars` sections. Ensure they correctly point to your `tmLanguage.json` file and define the language ID (`spl`), scope name (`source.spl`), and file extensions (`.spl`). The `yo code` generator should have set most of this up correctly, but it's good to double-check.

    Example `package.json` snippet (ensure paths match your project structure):
    ```json
    {
      // ... other package.json fields
      "contributes": {
        "languages": [{
          "id": "spl",
          "aliases": ["SPL", "Structured Prompt Language"],
          "extensions": [".spl"],
          "configuration": "./language-configuration.json"
        }],
        "grammars": [{
          "language": "spl",
          "scopeName": "source.spl",
          "path": "./syntaxes/tmLanguage.json"
        }]
      }
      // ...
    }
    ```

4.  **Test Your Extension:**
    *   Open your extension project in VS Code.
    *   Press `F5` to launch a new "Extension Development Host" window. This window will have your extension loaded.
    *   In the "Extension Development Host" window, create a new file (e.g., `test.spl`) and paste some SPL code into it.
    *   Verify that your syntax highlighting is applied correctly.

5.  **Package Your Extension and Alternative Testing Method:**

    **Prerequisites:**
    *   Install vsce (VS Code Extension CLI):
        ```bash
        npm install -g @vscode/vsce
        ```

    **Required package.json Configuration:**
    Before packaging, ensure your `package.json` includes these required fields:
    ```json
    {
      "name": "spl-llm",
      "publisher": "digital-duck",
      "license": "Apache-2.0",
      "engines": {
        "vscode": "^1.108.0"
      },
      "devDependencies": {
        "@types/vscode": "^1.108.0"
      }
    }
    ```

    **Install Dependencies:**
    ```bash
    cd your-extension-directory
    npm install
    ```

    **Packaging:**
    *   Package your extension into a `.vsix` file:
        ```bash
        vsce package
        ```
        This will create a `.vsix` file (e.g., `spl-llm-0.0.1.vsix`) in your project directory.

    **Common Issues and Solutions:**
    *   **Error: `tsc: not found`** → Run `npm install` to install TypeScript and dependencies
    *   **Error: `undefined_publisher.spl-llm`** → Add `"publisher": "your-publisher-name"` to package.json
    *   **Error: VS Code version incompatibility** → Ensure `engines.vscode` matches your VS Code version
    *   **Error: `@types/vscode greater than engines.vscode`** → Align both versions in package.json

    **Installation and Testing:**
    *   **Manual Installation:** Install the generated `.vsix` file:
        ```bash
        code --install-extension spl-llm-0.0.1.vsix
        ```
    *   **Test:** Create a `.spl` file and verify syntax highlighting works:
        ```bash
        echo 'PROMPT test
        WITH BUDGET 1000 tokens
        SELECT system_role("Assistant") AS system;' > test.spl
        code test.spl
        ```

    **Alternative Development Testing:**
    *   Open your extension project in VS Code
    *   Press `F5` to launch "Extension Development Host" window
    *   Create/open `.spl` files in the development host to test changes

6.  **Publish Your Extension (Optional):**
    If you wish to share your extension with others by publishing it to the Visual Studio Code Marketplace, follow these steps. Please note that publishing requires some prerequisites and a more detailed setup than covered here.

    *   **Prerequisites:**
        *   An Azure DevOps Organization.
        *   A Personal Access Token (PAT) with "Marketplace (Publish)" scope.
        *   A Publisher ID registered with the VS Code Marketplace.

    *   **Publishing Command:**
        Once you have your publisher setup and PAT, you can publish your extension from your project directory:
        ```bash
        vsce publish
        ```
        This command will prompt you for your Personal Access Token.

    *   **For Detailed Instructions:**
        The official VS Code documentation provides comprehensive, up-to-date instructions on how to set up a publisher, obtain a Personal Access Token, and publish your extension to the Marketplace:
        [Publishing Extensions - Visual Studio Code Documentation](https://code.visualstudio.com/api/references/publishing-extensions)
